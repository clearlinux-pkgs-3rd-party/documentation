# Set-up a server for hosting a swupd 3rd-party repository

## Table of contents
1. [Introduction](#introduction)
2. [Requirements](#requirements)
3. [Install NGINX](#nginx)
4. [Configure NGINX](#nginx-config)
    1. [Traefik](#traefik)
5. [Upload content](#content)

## Introduction<a name="introduction"></a>
This guide is meant for anyone wondering how to host a 3d-party repository to be consumed by swupd in Clear Linux. This guide will however not go into very much detail as there are a million ways to do most of the steps in this process. You will also not learn how to create the content (packages and bundles) to be hosted on your server. With this warning out of the way we can continue.

## Requirements<a name="requirements"></a>
Hosting a 3rd-party repository doesn't require a lot of a server, the 2 things it does require is a lot of disk space and a lot of bandwidth. The exact amount of these 2 depends on the situation, but generally the more packages you host the more disk space is required. As for the needed amount of bandwidth this depends on the amount of up- and downloads. Furthermore you should be able to host files in a plain directory, this can be done on any NGINX or Apache server. I use a VPS for hosting my repository but it should work on a shared hosting package as well. For the rest of this guide I assume a VPS set-up. If you are running on a shared host you need to figure out how to enable indexing on the folder you want to use for hosting the repository, after doing so you can continue to [Upload content](#content).

## Install NGINX<a name="nginx"></a>
In order for swupd to be able to use a repository it needs to have access to the files in a folder hosted on an https(s) accessible server, for this you need to install NGINX on your VPS the exact steps are different for every Linux distribution but an example can be found [here](https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-18-04).

## Configure NGINX<a name="nginx-config"></a>
As explained in the tutorial we need to create a new (sub)domain in our NGINX installation, I used the following configuration for my subdomain.

```
server {
    listen 80;
    server_name subdomain.domain.tld;
    root /usr/share/nginx/html;
	autoindex on;
	disable_symlinks off;
}
```

In the above config file you should change your root to the folder where you will store the content generated by swupd. You should also change your server name to the one you configured. The autoindex option is required to enable a simple folder view and to allow swupd to easily access the folder. I have also enabled symlinks as my root folder is a simple symlink to another folder. If your root is the actual folder where the content is stored then feel free to omit it.

I used port 80 since my installation is behind a Traefik installation that takes care of enabling https on my server. It is not required to serve the content over https, but it is recommended, if you do not enable https you need to add your repository to swupd with the --allow-insecure-http flag e.g.

```
sudo swupd 3rd-party add my-3rd-party-repo \
http://clear.greginator.xyz --allow-insecure-http
```

### Traefik<a name="traefik"></a>
For more information on how to install and use Traefik click [here](https://medium.com/@containeroo/traefik-2-0-docker-a-simple-step-by-step-guide-e0be0c17cfa5). 

Example docker-compose file for serving NGINX over Traefik:
```
version: '3'

services:
  nginx:
    restart: always
    image: nginx:alpine
    container_name: cdn
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
    volumes:
      - ./config/nginx:/etc/nginx/conf.d
      - ./static:/usr/share/nginx/html
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cdn.entrypoints=http"
      - "traefik.http.routers.cdn.rule=Host(`sudomain.domain.com`)"
      - "traefik.http.middlewares.cdn-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.cdn.middlewares=cdn-https-redirect"
      - "traefik.http.routers.cdn-secure.entrypoints=https"
      - "traefik.http.routers.cdn-secure.rule=Host(`sudomain.domain.com`)"
      - "traefik.http.routers.cdn-secure.tls=true"
      - "traefik.http.routers.cdn-secure.tls.certresolver=http"
      - "traefik.http.routers.cdn-secure.service=cdn"
      - "traefik.http.services.cdn.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"

networks:
  proxy:
    external: true
```

## Upload content<a name="content"></a>
When you have created your own bundles using mixer you will have a folder named update in your mixer workspace.
This folder contains a subfolder named www which contents are the files you have to upload to the server. 
Again there are a ton of ways to upload this folder to the correct folder on the server, but I used scp since I think it is easy to use and I have SSH access to my VPS.

An example command to upload the contents of update/www/ to the server:
```
scp -r update/www/*  user@server_ip:/path/to/folder/on/server
```

When our upload is finished the content should be accessible on your own server, and it should look like the structure of [https://cdn.download.clearlinux.org/](https://cdn.download.clearlinux.org/).

Now you have a fully functional 3rd-party repository available to be used by swupd.

---

## Extra references
* [Official swupd 3rd-party documentation](https://docs.01.org/clearlinux/latest/guides/clear/swupd-3rd-party.html)
* [Initial server setup with Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04)
* [Docker installation](https://docs.docker.com/engine/install/)